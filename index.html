<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K.R.O Media - PIN System</title>
    <style>
        /* ALL YOUR EXISTING CSS REMAINS - plus these new styles */
        
        /* PIN System Styles */
        .pin-badge {
            background: linear-gradient(135deg, #ff3b9c, #9d4edd);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .phone-locked {
            filter: blur(4px);
            user-select: none;
            background: rgba(255, 59, 156, 0.1);
            padding: 5px 10px;
            border-radius: 8px;
            display: inline-block;
        }
        
        .pin-input-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .pin-input {
            flex: 1;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: white;
            font-size: 1.2em;
            letter-spacing: 4px;
            text-align: center;
        }
        
        .pin-input:focus {
            border-color: #ff3b9c;
            box-shadow: 0 0 20px rgba(255, 59, 156, 0.3);
        }
        
        .pin-button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #ff3b9c, #9d4edd);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .pin-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(255, 59, 156, 0.5);
        }
        
        .pin-button.secondary {
            background: transparent;
            border: 1px solid #4d9eff;
        }
        
        .pin-button.secondary:hover {
            background: #4d9eff;
        }
        
        .pins-remaining {
            display: inline-block;
            background: rgba(77, 158, 255, 0.2);
            border: 1px solid #4d9eff;
            color: #4d9eff;
            padding: 5px 15px;
            border-radius: 25px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .call-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #4d9eff;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .call-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #4d9eff;
        }
        
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .pricing-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pricing-card:hover {
            border-color: #ff3b9c;
            transform: translateY(-5px);
        }
        
        .pricing-card.selected {
            border-color: #ff3b9c;
            background: rgba(255, 59, 156, 0.1);
            box-shadow: 0 0 30px rgba(255, 59, 156, 0.3);
        }
        
        .pricing-quantity {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(135deg, #ff3b9c, #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .pricing-price {
            font-size: 1.2em;
            color: #a4ff7c;
            margin: 10px 0;
        }
        
        .pricing-bonus {
            font-size: 0.9em;
            color: #b0b0b0;
        }
        
        .email-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }
        
        .email-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 0;
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .divider span {
            padding: 0 10px;
            color: #b0b0b0;
        }
        
        @media (max-width: 768px) {
            .pricing-grid {
                grid-template-columns: 1fr;
            }
            .pin-input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header (same) -->
    <div class="header" id="mainHeader">
        <div class="logo">K.R.O Media</div>
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showPage('home')">HOME</button>
            <button class="nav-btn" onclick="showPage('progress')">PROGRESS</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- YouTube Banners Section (same) -->
        <div class="youtube-section">
            <div class="section-header">
                <h2>üé• K.R.O MOVIES</h2>
                <span class="see-all">See All ‚Üí</span>
            </div>
            
            <div class="banners-container">
                <div class="banners-slider" id="bannersSlider">
                    <!-- Banners will be loaded dynamically -->
                </div>
            </div>
            
            <div class="slider-controls" id="sliderControls">
                <div class="slider-dot active"></div>
            </div>
        </div>

        <!-- Hero Section (same) -->
        <div class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">
                    <span class="neon">GET K.R.O</span>
                    <span class="creators">CONTRACTS</span>
                </h1>
                <p class="hero-description">
                    K.R.O Contracts brings together colleagues to support each other. Create, track, and resolve support contracts in a secure, transparent environment.
                </p>
                
                <div class="stats-row" id="statsRow">
                    <div class="stat-item">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completedContracts">0</div>
                        <div class="stat-label">Completed Contracts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalSupport">‚Ç¶0</div>
                        <div class="stat-label">Total Support</div>
                    </div>
                </div>

                <div class="hero-buttons">
                    <button class="btn-primary" onclick="openAddModal()">CREATE CONTRACT</button>
                    <button class="btn-secondary" onclick="showPage('progress')">VIEW PROGRESS</button>
                </div>
            </div>
            
            <div class="hero-image-container">
                <div class="glow-circle circle-1"></div>
                <div class="glow-circle circle-2"></div>
                <div class="glow-circle circle-3"></div>
                <div class="hero-floating-image" id="heroImage">
                    <img src="https://images.unsplash.com/photo-1573164713988-8665fc963095?w=800&auto=format" alt="Hero Image">
                </div>
            </div>
        </div>

        <!-- Action Bar (same) -->
        <div class="action-bar">
            <div class="search-box">
                <input type="text" placeholder="Search contracts..." id="searchInput" onkeyup="searchContracts()">
            </div>
            <div>
                <button class="filter-btn" onclick="openFilterModal()">FILTER</button>
                <button class="add-btn" onclick="openAddModal()">+ CREATE</button>
            </div>
        </div>

        <!-- Home Page -->
        <div id="homePage">
            <div class="section-header">
                <h2>Active Contracts</h2>
                <span class="see-all" onclick="openAllContractsModal()">See All ‚Üí</span>
            </div>
            <div class="contracts-grid" id="contractsGrid">
                <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #666;">Loading contracts...</div>
            </div>
        </div>

        <!-- Progress Page -->
        <div id="progressPage" style="display: none;">
            <div class="section-header">
                <h2>Progress Report</h2>
                <span class="see-all">See All ‚Üí</span>
            </div>
            <div class="progress-list" id="progressList">
                <div style="text-align: center; padding: 50px; color: #666;">Loading progress...</div>
            </div>
        </div>

        <!-- Featured Sections (same) -->
        <div class="featured-section">
            <div class="featured-card">
                <div class="featured-header">
                    <h3>‚ö° Top 5 Highest Contracts</h3>
                    <span class="see-all">See All ‚Üí</span>
                </div>
                <div id="topContractsList"></div>
            </div>

            <div class="featured-card">
                <div class="featured-header">
                    <h3>üèÜ Top 5 Staff</h3>
                    <span class="see-all">See All ‚Üí</span>
                </div>
                <div id="topStaffList"></div>
            </div>
        </div>

        <!-- Timer Section (same) -->
        <div class="timer-section">
            <div class="timer-info">
                <h3 class="glow-pink">Today's Highest Support</h3>
                <p id="todayHighest">‚Ç¶20,000.00 by K.R.O Service Company</p>
            </div>
            <div class="timer">
                <div class="timer-unit"><div class="timer-value">20</div><div class="timer-label">Day</div></div>
                <div class="timer-unit"><div class="timer-value">02</div><div class="timer-label">Month</div></div>
                <div class="timer-unit"><div class="timer-value">26</div><div class="timer-label">Year</div></div>
                <div class="timer-unit"><div class="timer-value">0:0</div><div class="timer-label">H:M</div></div>
            </div>
        </div>
    </div>

    <!-- Filter Modal (same) -->
    <div class="modal" id="filterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Filter by Status</h2>
                <span class="close-btn" onclick="closeFilterModal()">&times;</span>
            </div>
            <div class="filter-option" onclick="selectFilter('all')" id="filterAll">üìã All Contracts</div>
            <div class="filter-option" onclick="selectFilter('In Progress')" id="filterInProgress">‚è≥ In Progress</div>
            <div class="filter-option" onclick="selectFilter('Completed')" id="filterCompleted">‚úÖ Completed</div>
            <div class="filter-option" onclick="selectFilter('Not Started')" id="filterNotStarted">‚ö†Ô∏è Not Started</div>
            <div class="filter-actions">
                <button onclick="clearFilter()" class="btn-secondary">Clear all</button>
                <button onclick="applyFilter()" class="btn-primary" style="padding: 12px 25px;">Done</button>
            </div>
        </div>
    </div>

    <!-- ADD CONTRACT MODAL - UPDATED WITH PHONE NUMBER -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Contract</h2>
                <span class="close-btn" onclick="closeAddModal()">&times;</span>
            </div>
            
            <div id="formMessage"></div>
            
            <form id="addContractForm" onsubmit="saveNewContract(event)">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="title" placeholder="e.g., Cleaning Lady Needed" required>
                </div>
                
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" id="company" placeholder="e.g., K.R.O Services" required>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" placeholder="Describe the contract details..." required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Duration</label>
                        <input type="text" id="duration" placeholder="e.g., 2 Days Contract" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Worker ID</label>
                        <input type="text" id="workerId" placeholder="e.g., wrk-012" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount (‚Ç¶)</label>
                        <input type="number" id="amount" placeholder="20000" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Status</label>
                        <select id="status" required>
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Submission Date</label>
                        <input type="date" id="submissionDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Submitted By</label>
                        <input type="text" id="submittedBy" placeholder="Your name" required>
                    </div>
                </div>
                
                <!-- NEW: Phone Number Field -->
                <div class="form-group">
                    <label>Phone Number <span class="pin-badge">Hidden until unlocked</span></label>
                    <input type="tel" id="phoneNumber" placeholder="e.g., +234 123 456 7890" required>
                </div>
                
                <!-- Image Upload Section (same) -->
                <div class="form-group">
                    <label>Contract Image</label>
                    <div class="image-upload-container" id="imageUploadContainer" onclick="document.getElementById('imageInput').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                        <div class="upload-icon">üì∏</div>
                        <div class="upload-text">Click or drag image to upload</div>
                        <div class="upload-hint">Supports: JPG, PNG, GIF (Max 5MB)</div>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    </div>
                    <div class="image-preview" id="imagePreview">
                        <img src="" alt="Preview">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn-submit" id="submitBtn">Create Contract</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contract Detail Modal - UPDATED WITH VIEW CONTACT BUTTON & PIN SYSTEM -->
    <div class="modal" id="detailModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="detailTitle">Contract Details</h2>
                <span class="close-btn" onclick="closeDetailModal()">&times;</span>
            </div>
            
            <div class="detail-grid" id="detailContent">
                <!-- Detail content will be loaded here -->
            </div>

            <!-- NEW: View Contact Button & PIN Section -->
            <div style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span id="submittedByName" style="font-weight: 600;"></span>
                    <span class="pin-badge" id="pinsRemainingBadge" style="display: none;"></span>
                </div>
                <button class="btn-primary" id="viewContactBtn" onclick="openContactModal()" style="width: auto; padding: 10px 25px;">üë§ View Contact</button>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-secondary" onclick="closeDetailModal()" style="flex: 1;">Close Contract Detail</button>
            </div>
        </div>
    </div>

    <!-- NEW: Contact Modal with PIN System -->
    <div class="modal" id="contactModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Contact Information</h2>
                <span class="close-btn" onclick="closeContactModal()">&times;</span>
            </div>
            
            <div id="contactContent">
                <!-- Contact info will be loaded here -->
            </div>
            
            <div id="pinSection">
                <!-- PIN section will be dynamically loaded -->
            </div>
            
            <div id="emailSection" style="display: none;">
                <!-- Email section for free pins -->
            </div>
        </div>
    </div>

    <!-- NEW: Buy Pins Modal -->
    <div class="modal" id="buyPinsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üíé Purchase Pins</h2>
                <span class="close-btn" onclick="closeBuyPinsModal()">&times;</span>
            </div>
            
            <div class="pricing-grid">
                <div class="pricing-card" onclick="selectPinPackage(10)" id="package10">
                    <div class="pricing-quantity">10</div>
                    <div class="pricing-price">$10</div>
                    <div class="pricing-bonus">+0 bonus</div>
                </div>
                <div class="pricing-card" onclick="selectPinPackage(25)" id="package25">
                    <div class="pricing-quantity">25</div>
                    <div class="pricing-price">$20</div>
                    <div class="pricing-bonus">+5 bonus</div>
                </div>
                <div class="pricing-card" onclick="selectPinPackage(50)" id="package50">
                    <div class="pricing-quantity">50</div>
                    <div class="pricing-price">$35</div>
                    <div class="pricing-bonus">+15 bonus</div>
                </div>
            </div>
            
            <div class="email-section">
                <label>Email Address</label>
                <div class="email-input-group">
                    <input type="email" id="purchaseEmail" placeholder="your@email.com" class="pin-input">
                    <button class="pin-button" onclick="processPurchase()">Buy Now</button>
                </div>
            </div>
            
            <div class="divider">
                <span>or</span>
            </div>
            
            <button class="pin-button secondary" style="width: 100%;" onclick="checkBalance()">Check My Balance</button>
        </div>
    </div>

    <!-- All Contracts Modal (same) -->
    <div class="modal" id="allContractsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üìã All Contracts</h2>
                <span class="close-btn" onclick="closeAllContractsModal()">&times;</span>
            </div>
            <div class="all-contracts-list" id="allContractsList"></div>
        </div>
    </div>

    <!-- Staff Detail Modal (same) -->
    <div class="modal" id="staffDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Staff Profile</h2>
                <span class="close-btn" onclick="closeStaffDetailModal()">&times;</span>
            </div>
            <div id="staffDetailContent"></div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const GOOGLE_SHEETS_API_URL = 'https://script.google.com/macros/s/***REMOVED***/exec';
        const YOUTUBE_CREATORS_API_URL = 'https://script.google.com/macros/s/***REMOVED***/exec';
        const TOP_STAFF_API_URL = 'https://script.google.com/macros/s/***REMOVED***/exec';
        const HERO_IMAGE_API_URL = 'https://script.google.com/macros/s/***REMOVED***/exec';
        
        // NEW: PIN System API URL
        const PIN_API_URL = 'https://script.google.com/macros/s/***REMOVED***/exec';
        
        const IMGBB_API_KEY = '***REMOVED***';
        
        // ==================== GLOBAL VARIABLES ====================
        let contracts = [];
        let youtubeCreators = [];
        let topStaff = [];
        let currentFilter = 'all';
        let currentPage = 'home';
        let selectedContractId = null;
        let currentBannerIndex = 0;
        let bannerInterval;
        let selectedImageFile = null;
        let currentPhoneNumber = '';
        let currentContactName = '';
        let currentContractId = null;
        let userEmail = localStorage.getItem('kro_user_email') || '';
        let userPinsRemaining = 0;
        let selectedPinPackage = 10;
        const MAX_HOMEPAGE_CONTRACTS = 12;

        // ==================== PIN SYSTEM FUNCTIONS ====================
        async function checkPinBalance(email) {
            try {
                const response = await fetch(`${PIN_API_URL}?action=checkBalance&email=${encodeURIComponent(email)}`);
                const result = await response.json();
                
                if (result.success) {
                    userPinsRemaining = result.pinsRemaining;
                    updatePinsBadge();
                    return result;
                }
            } catch (error) {
                console.error('Error checking pin balance:', error);
            }
            return null;
        }

        function updatePinsBadge() {
            const badge = document.getElementById('pinsRemainingBadge');
            if (userPinsRemaining > 0) {
                badge.textContent = `${userPinsRemaining} pins left`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        async function getFreePins(email) {
            try {
                const response = await fetch(`${PIN_API_URL}?action=generateFreePins&email=${encodeURIComponent(email)}`);
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ ${result.message}`);
                    userEmail = email;
                    localStorage.setItem('kro_user_email', email);
                    await checkPinBalance(email);
                    closeContactModal();
                } else {
                    alert(`‚ùå ${result.error}`);
                }
            } catch (error) {
                console.error('Error getting free pins:', error);
                alert('Error requesting free pins. Please try again.');
            }
        }

        async function validatePin(pin) {
            if (!userEmail) {
                alert('Please enter your email first');
                return false;
            }
            
            try {
                const response = await fetch(`${PIN_API_URL}?action=validatePin&email=${encodeURIComponent(userEmail)}&pin=${pin}`);
                const result = await response.json();
                
                if (result.success) {
                    userPinsRemaining = result.pinsRemaining;
                    updatePinsBadge();
                    return true;
                } else {
                    alert(`‚ùå ${result.error}`);
                    return false;
                }
            } catch (error) {
                console.error('Error validating pin:', error);
                alert('Error validating pin. Please try again.');
                return false;
            }
        }

        function selectPinPackage(quantity) {
            selectedPinPackage = quantity;
            document.querySelectorAll('.pricing-card').forEach(card => card.classList.remove('selected'));
            document.getElementById(`package${quantity}`).classList.add('selected');
        }

        async function processPurchase() {
            const email = document.getElementById('purchaseEmail').value;
            if (!email) {
                alert('Please enter your email');
                return;
            }
            
            // In production, this would redirect to a payment gateway
            alert(`üõí Proceeding to payment for ${selectedPinPackage} pins...\n\nThis would connect to Stripe/PayPal in production.`);
            
            // After successful payment, call purchase API
            try {
                const response = await fetch(`${PIN_API_URL}?action=purchasePins&email=${encodeURIComponent(email)}&quantity=${selectedPinPackage}`);
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Purchase successful! ${selectedPinPackage} pins added to your account.`);
                    userEmail = email;
                    localStorage.setItem('kro_user_email', email);
                    await checkPinBalance(email);
                    closeBuyPinsModal();
                }
            } catch (error) {
                console.error('Error purchasing pins:', error);
                alert('Error processing purchase. Please try again.');
            }
        }

        async function checkBalance() {
            const email = document.getElementById('purchaseEmail').value;
            if (!email) {
                alert('Please enter your email');
                return;
            }
            
            const result = await checkPinBalance(email);
            if (result) {
                alert(`üìä You have ${result.pinsRemaining} pins remaining\nTotal purchased: ${result.totalPurchased}\nUsed: ${result.pinsUsed}`);
            }
        }

        // ==================== CONTACT MODAL FUNCTIONS ====================
        function openContactModal() {
            const modal = document.getElementById('contactModal');
            const content = document.getElementById('contactContent');
            const pinSection = document.getElementById('pinSection');
            const emailSection = document.getElementById('emailSection');
            
            // Show locked phone number
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3em; margin-bottom: 10px;">üë§</div>
                    <h3>${currentContactName}</h3>
                    <div style="margin: 20px 0;">
                        <div class="phone-locked">üîí ${currentPhoneNumber.replace(/\d(?=\d{4})/g, '*')}</div>
                        <p style="color: #b0b0b0; margin-top: 10px;">Enter PIN to unlock phone number</p>
                    </div>
                </div>
            `;
            
            if (userEmail) {
                // Show PIN input
                pinSection.innerHTML = `
                    <div class="pin-input-group">
                        <input type="text" class="pin-input" id="pinInput" placeholder="Enter 6-digit PIN" maxlength="6">
                        <button class="pin-button" onclick="unlockPhoneNumber()">Unlock</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="pins-remaining">${userPinsRemaining} pins remaining</span>
                        <button class="pin-button secondary" onclick="openBuyPinsModal()">Buy More Pins</button>
                    </div>
                `;
                emailSection.style.display = 'none';
            } else {
                // Show email input for free pins
                pinSection.innerHTML = '';
                emailSection.style.display = 'block';
                emailSection.innerHTML = `
                    <div class="email-section">
                        <p>New users get <strong>5 free pins</strong> to unlock phone numbers!</p>
                        <div class="email-input-group">
                            <input type="email" id="freePinEmail" placeholder="your@email.com" class="pin-input">
                            <button class="pin-button" onclick="requestFreePins()">Get Free Pins</button>
                        </div>
                        <p style="color: #b0b0b0; font-size: 0.9em; margin-top: 10px;">
                            Already have pins? 
                            <a href="#" onclick="showPinLogin()" style="color: #ff3b9c;">Enter PIN</a>
                        </p>
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }

        function showPinLogin() {
            document.getElementById('emailSection').style.display = 'none';
            document.getElementById('pinSection').innerHTML = `
                <div class="email-input-group" style="margin-top: 20px;">
                    <input type="email" id="loginEmail" placeholder="your@email.com" class="pin-input">
                    <button class="pin-button" onclick="loginWithEmail()">Continue</button>
                </div>
            `;
        }

        async function loginWithEmail() {
            const email = document.getElementById('loginEmail').value;
            if (!email) {
                alert('Please enter your email');
                return;
            }
            
            userEmail = email;
            localStorage.setItem('kro_user_email', email);
            await checkPinBalance(email);
            openContactModal(); // Refresh modal
        }

        async function requestFreePins() {
            const email = document.getElementById('freePinEmail').value;
            if (!email) {
                alert('Please enter your email');
                return;
            }
            
            await getFreePins(email);
        }

        async function unlockPhoneNumber() {
            const pin = document.getElementById('pinInput').value;
            if (!pin || pin.length !== 6) {
                alert('Please enter a valid 6-digit PIN');
                return;
            }
            
            const isValid = await validatePin(pin);
            if (isValid) {
                // Show unlocked phone number with call button
                document.getElementById('contactContent').innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3em; margin-bottom: 10px;">üë§</div>
                        <h3>${currentContactName}</h3>
                        <div style="margin: 20px 0;">
                            <div style="font-size: 1.5em; color: #a4ff7c;">üìû ${currentPhoneNumber}</div>
                            <a href="tel:${currentPhoneNumber}" class="call-button">
                                üìû Call Now
                            </a>
                        </div>
                        <p style="color: #b0b0b0; margin-top: 10px;">${userPinsRemaining} pins remaining</p>
                    </div>
                `;
                document.getElementById('pinSection').innerHTML = '';
            }
        }

        function closeContactModal() {
            document.getElementById('contactModal').style.display = 'none';
        }

        function openBuyPinsModal() {
            document.getElementById('buyPinsModal').style.display = 'flex';
        }

        function closeBuyPinsModal() {
            document.getElementById('buyPinsModal').style.display = 'none';
        }

        // ==================== EXISTING FUNCTIONS (UPDATED) ====================
        async function saveNewContract(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            submitBtn.innerHTML = '<span class="spinner"></span> Uploading...';
            submitBtn.disabled = true;
            
            document.getElementById('formMessage').innerHTML = '';
            
            try {
                let imageUrl = '';
                
                if (selectedImageFile) {
                    document.getElementById('formMessage').innerHTML = `
                        <div class="success-message">üì§ Uploading image...</div>
                    `;
                    imageUrl = await uploadToImgbb(selectedImageFile);
                    if (!imageUrl) throw new Error('Image upload failed');
                }
                
                const newContract = {
                    title: document.getElementById('title').value,
                    company: document.getElementById('company').value,
                    description: document.getElementById('description').value,
                    duration: document.getElementById('duration').value,
                    workerId: document.getElementById('workerId').value,
                    amount: document.getElementById('amount').value,
                    status: document.getElementById('status').value,
                    submissionDate: document.getElementById('submissionDate').value,
                    submittedBy: document.getElementById('submittedBy').value,
                    phoneNumber: document.getElementById('phoneNumber').value, // NEW
                    image_url: imageUrl,
                    avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${document.getElementById('submittedBy').value}`
                };
                
                document.getElementById('formMessage').innerHTML = `
                    <div class="success-message">üíæ Saving contract...</div>
                `;
                
                await fetch(GOOGLE_SHEETS_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newContract)
                });
                
                document.getElementById('formMessage').innerHTML = `
                    <div class="success-message">‚úÖ Contract created successfully! Refreshing data...</div>
                `;
                
                document.getElementById('addContractForm').reset();
                document.getElementById('imagePreview').style.display = 'none';
                selectedImageFile = null;
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('submissionDate').value = today;
                
                setTimeout(() => {
                    loadContracts();
                    closeAddModal();
                }, 1500);
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('formMessage').innerHTML = `
                    <div class="error-message">‚ùå Error creating contract. Please try again.</div>
                `;
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // ==================== VIEW CONTRACT DETAIL - UPDATED ====================
        function viewContract(id) {
            selectedContractId = id;
            const contract = contracts.find(c => c.id == id);
            
            if (!contract) return;
            
            // Store contact info for the modal
            currentPhoneNumber = contract.phoneNumber || '+234 123 456 7890';
            currentContactName = contract.submittedBy;
            currentContractId = id;
            
            document.getElementById('detailTitle').textContent = contract.title;
            document.getElementById('submittedByName').textContent = contract.submittedBy;
            
            document.getElementById('detailContent').innerHTML = `
                <div class="detail-image">
                    <img src="${contract.image_url || 'https://via.placeholder.com/600x300/1a1a1a/ff3b9c?text=No+Image'}" alt="${contract.title}">
                </div>
                <div class="detail-row">
                    <div class="detail-label">Description</div>
                    <div class="detail-value">${contract.description}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Duration</div>
                    <div class="detail-value">${contract.duration}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Worker ID</div>
                    <div class="detail-value">${contract.workerId}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        <span class="status-badge ${contract.status.toLowerCase().replace(' ', '-')}">${contract.status}</span>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Amount</div>
                    <div class="detail-value">‚Ç¶${parseFloat(contract.amount).toLocaleString()}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">Submission Date</div>
                    <div class="detail-value">${new Date(contract.submissionDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                </div>
            `;
            
            // Check if user is logged in to show pins
            if (userEmail) {
                checkPinBalance(userEmail);
            }
            
            document.getElementById('detailModal').style.display = 'flex';
        }

        // ==================== LOAD HERO IMAGE ====================
        async function loadHeroImage() {
            try {
                const response = await fetch(HERO_IMAGE_API_URL);
                const result = await response.json();
                if (result.success && result.image_url) {
                    const heroImage = document.querySelector('#heroImage img');
                    heroImage.src = result.image_url;
                }
            } catch (error) {
                console.error('Error loading hero image:', error);
            }
        }

        // ==================== LOAD TOP STAFF ====================
        async function loadTopStaff() {
            try {
                const response = await fetch(TOP_STAFF_API_URL);
                const result = await response.json();
                if (result.success) {
                    topStaff = result.data;
                    displayTopStaff();
                } else {
                    console.error('Failed to load top staff:', result.error);
                    useFallbackStaff();
                }
            } catch (error) {
                console.error('Error loading top staff:', error);
                useFallbackStaff();
            }
        }

        function useFallbackStaff() {
            topStaff = [
                { name: 'Chukwudi', position: 'Contract Staff', joined: '2 weeks ago', companyMeetings: 1, wellBehaved: 4, consistentMarketing: 7, broughtClient: 100, closedDeal: 1000, multipleDeals: 5000, totalPoints: 6112 },
                { name: 'Cynthia', position: 'Marketing Lead', joined: '1 month ago', companyMeetings: 3, wellBehaved: 5, consistentMarketing: 10, broughtClient: 200, closedDeal: 500, multipleDeals: 2500, totalPoints: 3218 },
                { name: 'Godwin', position: 'Sales Rep', joined: '3 weeks ago', companyMeetings: 2, wellBehaved: 3, consistentMarketing: 5, broughtClient: 150, closedDeal: 300, multipleDeals: 1000, totalPoints: 1460 },
                { name: 'Samuel', position: 'Team Lead', joined: '1 week ago', companyMeetings: 4, wellBehaved: 5, consistentMarketing: 8, broughtClient: 50, closedDeal: 200, multipleDeals: 500, totalPoints: 767 },
                { name: 'Obina', position: 'Junior Staff', joined: '2 days ago', companyMeetings: 1, wellBehaved: 2, consistentMarketing: 3, broughtClient: 10, closedDeal: 50, multipleDeals: 100, totalPoints: 166 }
            ];
            displayTopStaff();
        }

        function displayTopStaff() {
            const list = document.getElementById('topStaffList');
            if (!topStaff || topStaff.length === 0) {
                list.innerHTML = '<div class="bid-item">No staff found</div>';
                return;
            }
            
            const top5 = topStaff.slice(0, 5);
            const staffEmojis = ['üë±üèΩ‚Äç‚ôÇÔ∏è', 'üë©üèΩ‚Äçüíº', 'üë±üèΩ‚Äç‚ôÇÔ∏è', 'üë±üèΩ‚Äç‚ôÇÔ∏è', 'üë®üèΩ‚Äçüíº'];
            
            list.innerHTML = top5.map((staff, index) => `
                <div class="bid-item">
                    <div class="bid-info">
                        <div class="bid-avatar">${staffEmojis[index] || 'üë§'}</div>
                        <div class="bid-name">${staff.name}</div>
                    </div>
                    <button class="bid-button" onclick="viewStaffDetail(${index})">View</button>
                </div>
            `).join('');
        }

        function viewStaffDetail(index) {
            const staff = topStaff[index];
            if (!staff) return;
            
            const content = document.getElementById('staffDetailContent');
            const emoji = index === 0 ? 'üë±üèΩ‚Äç‚ôÇÔ∏è' : index === 1 ? 'üë©üèΩ‚Äçüíº' : index === 2 ? 'üë±üèΩ‚Äç‚ôÇÔ∏è' : index === 3 ? 'üë±üèΩ‚Äç‚ôÇÔ∏è' : 'üë®üèΩ‚Äçüíº';
            
            content.innerHTML = `
                <div class="staff-info">
                    <div class="staff-header">
                        <div class="staff-avatar-large">${emoji}</div>
                        <div class="staff-title">
                            <h3>${staff.name}</h3>
                            <p>${staff.position} ‚Ä¢ Joined ${staff.joined}</p>
                        </div>
                    </div>
                    
                    <div class="staff-detail-row">
                        <span class="staff-detail-label">Position</span>
                        <span class="staff-detail-value">${staff.position}</span>
                    </div>
                    
                    <div class="staff-detail-row">
                        <span class="staff-detail-label">Joined</span>
                        <span class="staff-detail-value">${staff.joined}</span>
                    </div>
                    
                    <div class="category-section">
                        <div class="category-title">üèÜ Performance Categories</div>
                        <div class="category-grid">
                            <div class="category-item">
                                <div class="category-name">Company Meetings</div>
                                <div class="category-points">${staff.companyMeetings} pts</div>
                            </div>
                            <div class="category-item">
                                <div class="category-name">Well Behaved</div>
                                <div class="category-points">${staff.wellBehaved} pts</div>
                            </div>
                            <div class="category-item">
                                <div class="category-name">Consistent Marketing</div>
                                <div class="category-points">${staff.consistentMarketing} pts</div>
                            </div>
                            <div class="category-item">
                                <div class="category-name">Brought Client</div>
                                <div class="category-points">${staff.broughtClient} pts</div>
                            </div>
                            <div class="category-item">
                                <div class="category-name">Closed Deal</div>
                                <div class="category-points">${staff.closedDeal} pts</div>
                            </div>
                            <div class="category-item">
                                <div class="category-name">Multiple Deals</div>
                                <div class="category-points">${staff.multipleDeals || 0} pts</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="total-points">
                        <div class="total-points-label">Total Points</div>
                        <div class="total-points-value">${staff.totalPoints.toLocaleString()}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('staffDetailModal').style.display = 'flex';
        }

        // ==================== LOAD YOUTUBE CREATORS ====================
        async function loadYouTubeCreators() {
            try {
                const response = await fetch(YOUTUBE_CREATORS_API_URL);
                const result = await response.json();
                
                if (result.success) {
                    youtubeCreators = result.data;
                    loadBanners();
                } else {
                    console.error('Failed to load YouTube creators:', result.error);
                    youtubeCreators = [
                        {
                            name: 'Tech with Sarah',
                            channel: '@techsarah',
                            subscribers: '15.2K',
                            avatar: 'üë©‚Äçüíª',
                            avatar_url: 'https://images.unsplash.com/photo-1573164713988-8665fc963095?w=150&auto=format',
                            link: 'https://youtube.com/@techsarah',
                            description: 'Tech reviews & tutorials',
                            image_url: 'https://images.unsplash.com/photo-1573164713988-8665fc963095?w=1400&auto=format'
                        },
                        {
                            name: 'Mike Gaming',
                            channel: '@mikegaming',
                            subscribers: '28.7K',
                            avatar: 'üéÆ',
                            avatar_url: 'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=150&auto=format',
                            link: 'https://youtube.com/@mikegaming',
                            description: 'Daily gaming content & live streams',
                            image_url: 'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=1400&auto=format'
                        }
                    ];
                    loadBanners();
                }
            } catch (error) {
                console.error('Error loading YouTube creators:', error);
                youtubeCreators = [
                    {
                        name: 'Tech with Sarah',
                        subscribers: '15.2K',
                        avatar: 'üë©‚Äçüíª',
                        avatar_url: 'https://images.unsplash.com/photo-1573164713988-8665fc963095?w=150&auto=format',
                        link: 'https://youtube.com/@techsarah',
                        description: 'Tech reviews & tutorials',
                        image_url: 'https://images.unsplash.com/photo-1573164713988-8665fc963095?w=1400&auto=format'
                    }
                ];
                loadBanners();
            }
        }

        function loadBanners() {
            const slider = document.getElementById('bannersSlider');
            const controls = document.getElementById('sliderControls');
            
            if (!youtubeCreators || youtubeCreators.length === 0) {
                slider.innerHTML = `
                    <div class="banner-slide">
                        <div class="youtube-banner" style="background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1573164713988-8665fc963095?w=1400&auto=format')">
                            <div class="banner-content">
                                <h3>No Creators Found</h3>
                                <p>Add creators to your Google Sheet to see them here</p>
                            </div>
                            <div class="banner-avatar">
                                <img src="https://images.unsplash.com/photo-1573164713988-8665fc963095?w=150&auto=format" alt="Avatar">
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            slider.innerHTML = youtubeCreators.map((creator, index) => `
                <div class="banner-slide">
                    <div class="youtube-banner" onclick="window.open('${creator.link}', '_blank')" style="background-image: linear-gradient(90deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.1) 100%), url('${creator.image_url || 'https://images.unsplash.com/photo-1573164713988-8665fc963095?w=1400&auto=format'}')">
                        <div class="banner-content">
                            <h3>${creator.name}</h3>
                            <p>${creator.description || 'YouTube Creator'}</p>
                            ${creator.subscribers ? `
                            <div class="banner-stats">
                                <div class="stat">
                                    <div class="stat-number">${creator.subscribers}</div>
                                    <div class="stat-label">Subscribers</div>
                                </div>
                            </div>
                            ` : ''}
                            <button class="banner-button" onclick="event.stopPropagation(); window.open('${creator.link}', '_blank')">Watch Now ‚Üí</button>
                        </div>
                        <div class="banner-avatar">
                            <img src="${creator.avatar_url || 'https://images.unsplash.com/photo-1573164713988-8665fc963095?w=150&auto=format'}" alt="${creator.name}">
                        </div>
                    </div>
                </div>
            `).join('');
            
            controls.innerHTML = youtubeCreators.map((_, index) => `
                <div class="slider-dot ${index === 0 ? 'active' : ''}" onclick="goToBanner(${index})"></div>
            `).join('');
            
            currentBannerIndex = 0;
            updateBannerPosition();
        }

        function startBannerSlide() {
            if (bannerInterval) clearInterval(bannerInterval);
            bannerInterval = setInterval(() => {
                if (youtubeCreators.length > 0) {
                    currentBannerIndex = (currentBannerIndex + 1) % youtubeCreators.length;
                    updateBannerPosition();
                }
            }, 5000);
        }

        function goToBanner(index) {
            currentBannerIndex = index;
            updateBannerPosition();
            clearInterval(bannerInterval);
            startBannerSlide();
        }

        function updateBannerPosition() {
            const slider = document.getElementById('bannersSlider');
            slider.style.transform = `translateX(-${currentBannerIndex * 100}%)`;
            
            document.querySelectorAll('.slider-dot').forEach((dot, index) => {
                if (index === currentBannerIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // ==================== IMAGE UPLOAD HANDLERS ====================
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedImageFile = file;
                previewImage(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            document.getElementById('imageUploadContainer').classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            document.getElementById('imageUploadContainer').classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            document.getElementById('imageUploadContainer').classList.remove('dragover');
            
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedImageFile = file;
                previewImage(file);
            } else {
                alert('Please drop an image file');
            }
        }

        function previewImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                const img = preview.querySelector('img');
                img.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function uploadToImgbb(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', IMGBB_API_KEY);
            
            try {
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    return data.data.url;
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('ImgBB upload error:', error);
                return null;
            }
        }

        // ==================== LOAD CONTRACTS ====================
        async function loadContracts() {
            try {
                const response = await fetch(GOOGLE_SHEETS_API_URL);
                const result = await response.json();
                
                if (result.success) {
                    contracts = result.data;
                    contracts.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
                    saveToStorage();
                    updateDisplay();
                } else {
                    console.error('API Error:', result.error);
                    loadFromStorage();
                }
            } catch (error) {
                console.error('Failed to load from Google Sheets:', error);
                loadFromStorage();
            }
        }

        // ==================== UPDATE DISPLAY ====================
        function updateDisplay() {
            displayContracts();
            displayProgress();
            updateStats();
            updateTopContracts();
        }

        function displayContracts() {
            const filtered = filterContracts(contracts);
            const grid = document.getElementById('contractsGrid');
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #666;">No contracts found</div>';
                return;
            }
            
            const displayContracts = filtered.slice(0, MAX_HOMEPAGE_CONTRACTS);
            
            grid.innerHTML = displayContracts.map(contract => `
                <div class="contract-card" data-status="${contract.status}" onclick="viewContract(${contract.id})">
                    <div class="contract-image">
                        <img src="${contract.image_url || 'https://via.placeholder.com/400x200/1a1a1a/ff3b9c?text=No+Image'}" alt="${contract.title}">
                    </div>
                    <div class="contract-content">
                        <div class="contract-amount">‚Ç¶${parseFloat(contract.amount).toLocaleString()}</div>
                        <div class="contract-title">${contract.title}</div>
                        <div class="contract-company">at ${contract.company}</div>
                        <div class="contract-meta">
                            <span class="status-badge ${contract.status.toLowerCase().replace(' ', '-')}">${contract.status}</span>
                            <span class="contract-date">üìÖ ${new Date(contract.submissionDate).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayProgress() {
            const filtered = filterContracts(contracts);
            const list = document.getElementById('progressList');
            
            if (filtered.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">No contracts found</div>';
                return;
            }
            
            list.innerHTML = filtered.map(contract => `
                <div class="progress-item" onclick="viewContract(${contract.id})">
                    <div class="progress-status ${contract.status.toLowerCase().replace(' ', '-')}"></div>
                    <div class="progress-content">
                        <div class="progress-title">
                            <span>${contract.status.toUpperCase()}</span> ‚Äî ${contract.title}
                        </div>
                        <div class="progress-date">Posted on ${new Date(contract.submissionDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            const activeUsers = new Set(contracts.map(c => c.workerId)).size;
            const completed = contracts.filter(c => c.status === 'Completed').length;
            const total = contracts.reduce((sum, c) => sum + parseFloat(c.amount || 0), 0);
            
            document.getElementById('activeUsers').textContent = activeUsers || '1,609';
            document.getElementById('completedContracts').textContent = completed || '247';
            document.getElementById('totalSupport').textContent = `‚Ç¶${(total / 1000).toFixed(1)}K`;
            
            if (contracts.length > 0) {
                const highest = [...contracts].sort((a, b) => parseFloat(b.amount) - parseFloat(a.amount))[0];
                document.getElementById('todayHighest').innerHTML = `‚Ç¶${parseFloat(highest.amount).toLocaleString()} by ${highest.company}`;
            }
        }

        function updateTopContracts() {
            const topContracts = [...contracts]
                .sort((a, b) => parseFloat(b.amount) - parseFloat(a.amount))
                .slice(0, 5);
            
            const container = document.getElementById('topContractsList');
            
            if (topContracts.length === 0) {
                container.innerHTML = '<div class="bid-item">No contracts found</div>';
                return;
            }
            
            container.innerHTML = topContracts.map((contract, index) => `
                <div class="bid-item">
                    <div class="bid-info">
                        <div class="bid-avatar">${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üí∞'}</div>
                        <div>
                            <div class="bid-name">${contract.title}</div>
                            <div class="bid-amount">‚Ç¶${parseFloat(contract.amount).toLocaleString()}</div>
                        </div>
                    </div>
                    <button class="bid-button" onclick="viewContract(${contract.id})">View</button>
                </div>
            `).join('');
        }

        // ==================== LOCAL STORAGE ====================
        function saveToStorage() {
            localStorage.setItem('kro_contracts', JSON.stringify(contracts));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('kro_contracts');
            if (saved) {
                contracts = JSON.parse(saved);
                contracts.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));
                updateDisplay();
            }
        }

        // ==================== FILTER FUNCTIONS ====================
        function filterContracts(contractsList) {
            if (currentFilter === 'all') return contractsList;
            return contractsList.filter(c => c.status === currentFilter);
        }

        function selectFilter(status) {
            currentFilter = status;
            document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
            const filterId = status === 'all' ? 'filterAll' : `filter${status.replace(' ', '')}`;
            document.getElementById(filterId).classList.add('selected');
        }

        function applyFilter() {
            closeFilterModal();
            displayContracts();
            displayProgress();
        }

        function clearFilter() {
            currentFilter = 'all';
            document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('filterAll').classList.add('selected');
            displayContracts();
            displayProgress();
        }

        // ==================== SEARCH FUNCTION ====================
        function searchContracts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm === '') {
                displayContracts();
                return;
            }
            
            const filtered = contracts.filter(c => 
                c.title.toLowerCase().includes(searchTerm) || 
                c.company.toLowerCase().includes(searchTerm) ||
                c.description.toLowerCase().includes(searchTerm)
            );
            
            if (currentPage === 'home') {
                const grid = document.getElementById('contractsGrid');
                if (filtered.length === 0) {
                    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #666;">No contracts found</div>';
                } else {
                    const displayContracts = filtered.slice(0, MAX_HOMEPAGE_CONTRACTS);
                    grid.innerHTML = displayContracts.map(contract => `
                        <div class="contract-card" data-status="${contract.status}" onclick="viewContract(${contract.id})">
                            <div class="contract-image">
                                <img src="${contract.image_url || 'https://via.placeholder.com/400x200/1a1a1a/ff3b9c?text=No+Image'}" alt="${contract.title}">
                            </div>
                            <div class="contract-content">
                                <div class="contract-amount">‚Ç¶${parseFloat(contract.amount).toLocaleString()}</div>
                                <div class="contract-title">${contract.title}</div>
                                <div class="contract-company">at ${contract.company}</div>
                                <div class="contract-meta">
                                    <span class="status-badge ${contract.status.toLowerCase().replace(' ', '-')}">${contract.status}</span>
                                    <span class="contract-date">üìÖ ${new Date(contract.submissionDate).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        // ==================== ALL CONTRACTS MODAL ====================
        function openAllContractsModal() {
            displayAllContracts();
            document.getElementById('allContractsModal').style.display = 'flex';
        }

        function closeAllContractsModal() {
            document.getElementById('allContractsModal').style.display = 'none';
        }

        function displayAllContracts() {
            const container = document.getElementById('allContractsList');
            
            if (contracts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 30px; color: #666;">No contracts found</div>';
                return;
            }
            
            container.innerHTML = contracts.map(contract => `
                <div class="contract-list-item">
                    <div class="list-item-image">
                        <img src="${contract.image_url || 'https://via.placeholder.com/60x60/1a1a1a/ff3b9c?text=No+Image'}" alt="${contract.title}">
                    </div>
                    <div class="list-item-content">
                        <div class="list-item-title">${contract.title}</div>
                        <div class="list-item-details">
                            <span class="list-item-amount">‚Ç¶${parseFloat(contract.amount).toLocaleString()}</span>
                            <span class="list-item-status ${contract.status.toLowerCase().replace(' ', '-')}">${contract.status}</span>
                        </div>
                    </div>
                    <button class="list-item-button" onclick="viewContractFromList(${contract.id})">View</button>
                </div>
            `).join('');
        }

        function viewContractFromList(id) {
            closeAllContractsModal();
            viewContract(id);
        }

        // ==================== PAGE NAVIGATION ====================
        function showPage(page) {
            currentPage = page;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (page === 'home') {
                document.getElementById('homePage').style.display = 'block';
                document.getElementById('progressPage').style.display = 'none';
            } else {
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('progressPage').style.display = 'block';
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        function openFilterModal() {
            document.getElementById('filterModal').style.display = 'flex';
        }

        function closeFilterModal() {
            document.getElementById('filterModal').style.display = 'none';
        }

        function openAddModal() {
            document.getElementById('addModal').style.display = 'flex';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('submissionDate').value = today;
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('addContractForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('formMessage').innerHTML = '';
            selectedImageFile = null;
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function closeStaffDetailModal() {
            document.getElementById('staffDetailModal').style.display = 'none';
        }

        // ==================== INITIAL LOAD ====================
        window.onload = function() {
            loadYouTubeCreators();
            loadTopStaff();
            loadContracts();
            loadHeroImage();
            startBannerSlide();
            
            // Check if user was previously logged in
            if (userEmail) {
                checkPinBalance(userEmail);
            }
        };

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['filterModal', 'addModal', 'detailModal', 'staffDetailModal', 'allContractsModal', 'contactModal', 'buyPinsModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>